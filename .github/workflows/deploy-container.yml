name: Deploy to Azure Container App Service

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to deploy'
        required: true
        default: 'web'
        type: choice
        options:
          - web
          - api

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: acr-learning-rg
  AZURE_LOCATION: eastus
  ENVIRONMENT_NAME: dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Project Variables
        id: vars
        run: |
          if [[ "${{ github.event.inputs.project }}" == "api" ]]; then
            echo "dockerfile=src/PublicApi/Dockerfile" >> $GITHUB_OUTPUT
            echo "image_name=eshop-api" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=src/Web/Dockerfile" >> $GITHUB_OUTPUT
            echo "image_name=eshop-web" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        uses: azure/arm-deploy@v2
        id: deploy
        with:
          scope: subscription
          region: ${{ env.AZURE_LOCATION }}
          template: ./infra/main.bicep
          parameters: >
            resourceGroupName=${{ env.AZURE_RESOURCE_GROUP }}
            environmentName=${{ env.ENVIRONMENT_NAME }}
            location=${{ env.AZURE_LOCATION }}

      - name: Get ACR Credentials
        id: acr_creds
        run: |
          echo "password=$(az acr credential show --name ${{ steps.deploy.outputs.acrName }} --query "passwords[0].value" -o tsv)" >> $GITHUB_OUTPUT

      - name: Log in to Docker
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.deploy.outputs.acrLoginServer }}
          username: ${{ steps.deploy.outputs.acrName }}
          password: ${{ steps.acr_creds.outputs.password }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.vars.outputs.dockerfile }}
          push: true
          tags: ${{ steps.deploy.outputs.acrLoginServer }}/${{ steps.vars.outputs.image_name }}:${{ github.sha }}

      - name: Deploy to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.deploy.outputs.webServiceName }}
          images: ${{ steps.deploy.outputs.acrLoginServer }}/${{ steps.vars.outputs.image_name }}:${{ github.sha }}
